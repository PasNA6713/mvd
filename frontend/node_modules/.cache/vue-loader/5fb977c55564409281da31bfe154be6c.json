{"remainingRequest":"/home/john/Documents/Projects/Хакатоны/mvd/frontend/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/john/Documents/Projects/Хакатоны/mvd/frontend/src/components/map/ClusterMap.vue?vue&type=style&index=0&id=42cc6ab9&lang=scss&scoped=true&","dependencies":[{"path":"/home/john/Documents/Projects/Хакатоны/mvd/frontend/src/components/map/ClusterMap.vue","mtime":1620586744637},{"path":"/home/john/Documents/Projects/Хакатоны/mvd/frontend/node_modules/css-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/john/Documents/Projects/Хакатоны/mvd/frontend/node_modules/vue-loader/lib/loaders/stylePostLoader.js","mtime":499162500000},{"path":"/home/john/Documents/Projects/Хакатоны/mvd/frontend/node_modules/postcss-loader/src/index.js","mtime":499162500000},{"path":"/home/john/Documents/Projects/Хакатоны/mvd/frontend/node_modules/sass-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/john/Documents/Projects/Хакатоны/mvd/frontend/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/john/Documents/Projects/Хакатоны/mvd/frontend/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgpAaW1wb3J0ICdAL3N0eWxlcy9jb21wb25lbnRzL21hcC5zY3NzJzsK"},{"version":3,"sources":["ClusterMap.vue"],"names":[],"mappings":";;;;;;;;;;;;;;AAcA","file":"ClusterMap.vue","sourceRoot":"src/components/map","sourcesContent":["<template>\n    <yandex-map id=\"map\"\n      :settings=\"settings\"\n      :coords=\"mapCenter\"\n      :zoom=\"10\" \n      :use-object-manager=\"true\"\n      :scrollZoom=\"false\"\n      :controls=\"['zoomControl']\"\n      @map-was-initialized=\"getMapInstance\"\n    >\n    </yandex-map>\n</template>\n\n<style lang=\"scss\" scoped>\n@import '@/styles/components/map.scss';\n</style>\n\n<script>\nimport { yandexMap, ymapMarker } from 'vue-yandex-maps'\nimport { formatedDateTime } from '@/utils/helpers.js'\n\nexport default {\n  name: \"ClusterMap\",\n  \n  props: {\n    filterParams: Object\n  },\n\n  components: {\n    yandexMap,\n    ymapMarker\n  },\n\n  data() {\n    return {\n      clusterMap: null,\n      settings: {\n        apiKey: 'e70694c3-ce7f-4459-b7f6-be3d53e2cc8e',\n        lang: 'ru_RU',\n        coordorder: 'latlong',\n        version: '2.1',\n      },\n      mapCenter: [59.9370, 30.3089],\n      clusters: [],\n      points: [],\n      clusterCounter: 1,\n      objectManager: null,\n\n      pressed: false,\n      userPoint: {\n        coords: null,\n        points: null,\n      },\n      userPlacemark: null\n    }\n  },\n\n  methods: {\n    drawTable(cluster, cid) {\n      for(let i=0;i<cluster.length;i++) {\n        cluster[i].datetime = formatedDateTime(cluster[i].datetime)\n        cluster[i].cid = cid\n      }\n\n      this.$emit('get-table',cluster)\n    },\n\n    clickPoint(e) {\n      let target = e.get('objectId')\n      let point = this.objectManager.objects.getById(target)\n\n      axios.post(`${this.$store.state.backendUrl}/map/some/`,{\n        ids: point.properties.points\n      }).then(response => {\n        this.drawTable(response.data, point.id)\n\n        let scrollElement = document.getElementById('map');\n        scrollElement.scrollBottom = scrollElement.scrollHeight;\n        this.$vuetify.goTo(scrollElement);\n      })\n    },\n\n    async getMapInstance(map) {\n      if(map) {\n        try {\n          this.clusterMap = map\n          this.objectManager = new ymaps.ObjectManager({\n            clusterize: false,\n            gridSize: 32,\n            clusterDisableClickZoom: true\n          })\n          this.clusterMap.geoObjects.events.add('click', (e) => (this.clickPoint(e)))\n          this.clusterMap.events.add('click', (e) => (this.clickUserPoint(e)))\n\n          try {\n            this.objectManager.add(this.clusters)\n            this.clusterMap.geoObjects.add(this.objectManager)\n          } catch (error) {\n            console.log('no clusters!')\n          }\n        } catch (error) {\n          console.log(error)\n        }\n      }\n    },\n\n    async clickUserPoint(e) {\n      if (this.pressed) {\n          if (this.userPlacemark) {\n            this.clusterMap.geoObjects.remove(this.userPlacemark)\n          }\n\n          this.userPoint.coords = e.get('coords')\n\n          await axios.post(`${this.$store.state.backendUrl}/map/range/?category=Убийство`, {\n              lat: this.userPoint.coords[0],\n              long: this.userPoint.coords[1]\n          }).then(response => {\n              this.userPlacemark = new ymaps.Placemark(this.userPoint.coords)\n              this.clusterMap.geoObjects.add(this.userPlacemark)\n              this.pressed = false\n          })\n        }\n    },\n\n    changeAccessToMap() {\n      this.pressed = !this.pressed\n    },\n\n    deleteUserPoint() {\n      this.clusterMap.geoObjects.remove(this.userPlacemark)\n      this.userPlacemark = null\n    },\n  },\n\n  watch: {\n    filterParams: function(filterParams) {\n      this.objectManager.removeAll()\n      this.clusters = []\n\n      axios.get(`${this.$store.state.backendUrl}/cluster/${filterParams.cluster_quontity}/`, {\n        params: {\n          category: filterParams.category,\n          region: filterParams.region,\n          light: filterParams.light,\n          datetime_before: filterParams.datetime_before, \n          datetime_after: filterParams.datetime_after,\n          time_group: filterParams.time_group\n        }\n      }\n      ).then(response => {\n            for (let i=0; i<response.data.length;i++){\n              let cluster = {\n                type: 'Feature',\n                id: this.clusterCounter,\n                geometry: {\n                    type: 'Point',\n                    coordinates: [response.data[i][\"lat\"], response.data[i][\"long\"]]\n                },\n                properties: {\n                    points: response.data[i][\"points\"]\n                },\n                options: {\n                    preset: \"islands#dotIcon\",\n                    iconColor: \"red\"\n                }\n              }\n              \n              this.clusterCounter += 1\n              this.clusters.push(cluster)\n              this.points.push(...cluster.properties.points)\n            }\n          \n          this.objectManager.add(this.clusters)\n          axios.post(`${this.$store.state.backendUrl}/map/some/`,{\n            ids: this.points\n          }).then(response => {\n            for(let i=0;i<response.data.length;i++) response.data[i].datetime = formatedDateTime(response.data[i].datetime)\n            this.$emit('get-table',response.data)\n          })\n      })\n    }\n  }\n}\n</script>"]}]}